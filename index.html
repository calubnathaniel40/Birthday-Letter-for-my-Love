<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Happy Birthday â€” For My Love ðŸ’–</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<!-- jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  /* ---------- base / layout / dreamy visual styles ---------- */
  :root{
    --soft-pink:#ffc0d6;
    --deep-bg-1:#0b0710;
    --accent: rgba(255,182,193,0.15);
    --glass: rgba(255,240,245,0.06);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;width:100%}
  body{
    font-family:"Poppins",system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(circle at 35% 20%, rgba(30,8,30,0.55), #040006 40%), linear-gradient(180deg,#05010a 0%, #000000 100%);
    color:#fff;
    -webkit-font-smoothing:antialiased;
    overflow-y:auto;
  }

  /* Intro */
  #intro-screen{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;
    background:linear-gradient(180deg, rgba(0,0,0,0.95), rgba(8,3,10,0.98));z-index:120;padding:20px;text-align:center;
  }
  #intro-screen h1{font-family:"Great Vibes",cursive;font-size:2.7rem;color:var(--soft-pink);text-shadow:0 6px 30px rgba(255,120,160,0.18)}
  #intro-screen .sub{color:rgba(255,220,235,0.9)}
  #start-btn{background:linear-gradient(45deg,#ff85a2,#ffb6c1);border:none;color:#fff;padding:12px 30px;border-radius:28px;font-weight:600;cursor:pointer;box-shadow:0 10px 40px rgba(255,150,200,0.12)}
  #start-btn:active{transform:scale(.995)}

  /* App layout */
  .hidden{display:none}
  #app{min-height:100vh;padding:20px 16px 90px;max-width:1100px;margin:0 auto;position:relative;z-index:2}
  .hero{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
  .title{font-family:"Great Vibes",cursive;font-size:2.1rem;color:#ffd1dc;margin:10px 0 18px;text-shadow:0 0 12px #ff7fa6}
  .controls{display:flex;gap:8px}
  .btn-small{background:#ffe6ee;border:none;padding:8px 10px;color:#5a1a2a;border-radius:10px;cursor:pointer}

  /* background decor (soft bokeh / vignette) */
  #bg-decor{position:fixed;inset:0;z-index:0;pointer-events:none}

  /* Gallery */
  .gallery-wrap{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:14px;z-index:3}
  .gallery{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;align-items:center}
  .photo{width:42vw;max-width:180px;height:54vw;max-height:220px;border-radius:14px;object-fit:cover;opacity:.3;transition:transform 1s ease,opacity 1s ease,filter 1s;box-shadow:0 12px 40px rgba(0,0,0,0.45)}
  .photo.active{opacity:1;transform:scale(1.06);box-shadow:0 30px 80px rgba(255,182,193,0.12);filter:saturate(1.02)}

  .caption{color:#ffdfe7;font-size:0.95rem;min-height:18px;margin-top:6px;text-align:center}

  /* letter */
  #letterBox{display:block;width:100%;max-width:860px;margin:16px auto 20px;position:relative;z-index:4}
  #typed{background:var(--glass);border-radius:18px;padding:28px;font-family:"Great Vibes",cursive;font-size:1.35rem;line-height:1.7;color:#ffe6ef;box-shadow:0 18px 60px rgba(0,0,0,0.6);backdrop-filter: blur(6px);max-height:60vh;overflow:auto;border:1px solid rgba(255,192,203,0.18)}

  /* final overlay */
  #finalOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:linear-gradient(180deg, rgba(10,2,8,0.6), rgba(0,0,0,0.9));z-index:400;opacity:0;pointer-events:none;transition:opacity 1s ease}
  #finalOverlay.show{opacity:1;pointer-events:auto}
  #finalOverlay h1{font-family:"Great Vibes",cursive;font-size:2.8rem;color:#ffd1dc;margin-bottom:10px}
  #finalOverlay p{color:#ffe7ef;margin-bottom:16px;text-align:center;max-width:90%}

  /* floating/choreography helpers created by JS */
  .float{position:fixed;pointer-events:none;user-select:none;z-index:150}
  .glowDot{position:fixed;width:10px;height:10px;border-radius:50%;background:rgba(255,182,193,.45);filter:blur(6px);z-index:50;pointer-events:none}

  /* audio elements hidden */
  audio{display:none}

  /* responsiveness */
  @media(min-width:760px){ .photo{width:180px;height:220px} #typed{font-size:1.65rem} }
  @media(max-width:420px){ .title{font-size:1.9rem} #typed{font-size:1.05rem;max-height:65vh} .photo{width:40vw;height:56vw} }
</style>
</head>
<body>

<!-- INTRO -->
<div id="intro-screen" role="dialog" aria-modal="true">
  <h1>Happy Birthday, My Baby ðŸŽ‚</h1>
  <p class="sub">Tap Start to begin (audio requires a tap)</p>
  <button id="start-btn" class="btn-primary">ðŸ’– Start</button>
</div>

<!-- MAIN APP -->
<main id="app" class="hidden" aria-live="polite" aria-hidden="true">
  <div id="bg-decor" aria-hidden="true"></div>

  <header class="hero">
    <h2 class="title">Our Moments ðŸ’ž</h2>
    <div class="controls">
      <button id="downloadPdf" class="btn-small">Download Letter (PDF)</button>
      <button id="muteBtn" class="btn-small">Mute</button>
    </div>
  </header>

  <section class="gallery-wrap">
    <div id="gallery" class="gallery" aria-hidden="false"></div>
    <div id="caption" class="caption" aria-live="polite"></div>
  </section>

  <section id="letterBox">
    <div id="typed"></div>
  </section>
</main>

<!-- final overlay -->
<div id="finalOverlay" aria-hidden="true">
  <h1>Iâ€™ll love you forever â€” Nathan ðŸ’ž</h1>
  <p>Happy Birthday, my everything. Thank you for being you.</p>
  <button id="finalClose" class="btn-primary">Close</button>
</div>

<!-- AUDIO ELEMENTS (must match CONFIG song filenames) -->
<audio id="audio-song-1" preload="auto"></audio>
<audio id="audio-song-2" preload="auto"></audio>
<audio id="audio-song-3" preload="auto"></audio>
<audio id="audio-song-4" preload="auto"></audio>
<audio id="audio-voice" preload="auto"></audio>

<!-- FINAL SCRIPT: your CONFIG + merged working logic -->
<script>
/* ===================== CONFIG - change filenames here if needed ===================== */
const CONFIG = {
  songs: [
    {file: "song1.mp3", title: "123 â€” Over October"},
    {file: "song2.mp3", title: "Until I Found Her"},
    {file: "song3.mp3", title: "Ikaw Pa Rin Ang Pipiliin Ko"},
    {file: "song4.mp3", title: "Leonora"}
  ],
  photoSets: [
    ["set1-1.jpg","set1-2.jpg","set1-3.jpg","set1-4.jpg"],
    ["set2-1.jpg","set2-2.jpg","set2-3.jpg","set2-4.jpg"],
    ["set3-1.jpg","set3-2.jpg","set3-3.jpg","set3-4.jpg"],
    ["set4-1.jpg","set4-2.jpg","set4-3.jpg","set4-4.jpg"],
    ["set5-1.jpg","set5-2.jpg","set5-3.jpg","set5-4.jpg"]
  ],
  captions: [
    ["EO yarn?","Road trip memories","Bleehhbleehhh","EK Moments"],
    ["Random galaa","Picture muna kayo?!","Birthdate?","Watch your sport"],
    ["Coffee dates","First date?","Ganda mo here","Coffee date ulit"],
    ["Same school?!","Hi po ate, pwede po magpapicture?","Your sport ulit (nagpapasarap sya)","EK I LOVE YOU"],
    ["Milestone smiles WOW","Jollibini who?","YIEE VALENTINES DAY","Jollibeeeeeee"]
  ],
  photoNarrations: [
    ["","","",""],["","","",""],["","","",""],["","","",""],["","","",""]
  ],
  voiceNote: "voice.mp3", // optional; place voice.mp3 or leave blank ""
  letter: `Happy Birthday, my baby!

Today is your special day, but honestly every day with you already feels special. Still, I want this day to be extra memorable because itâ€™s not just about celebrating your birthday, itâ€™s about celebrating you. The person who makes my world brighter, my heart calmer, and my life so much better just by being in it.

Youâ€™ve brought so much happiness into my life. Youâ€™ve shown me what real love feels like not the perfect but the real kind, where we learn, grow, and hold on to each other no matter what. Iâ€™m so thankful for every laugh weâ€™ve shared, every kwentalks, every moment we just sit together doing nothing but still feeling everything. Those moments mean more to me than I can ever explain.
I know weâ€™ve had our ups and downs, but thatâ€™s what makes us stronger. Weâ€™re learning, weâ€™re growing, and weâ€™re loving through it all. Iâ€™m proud of us, proud of how far weâ€™ve come and how we always find our way back to each other. Youâ€™re my peace, my safe place, and my favorite person to be with.

I wish for your happiness always not just today, but every single day that follows. I hope you keep chasing your dreams, smiling your beautiful smile, and knowing that Iâ€™ll always be here cheering for you, supporting you, and loving you with all that I am.

I canâ€™t wait to celebrate not just your birthdays but every milestone, every success, every little thing that makes life worth living together.
You deserve all the love, joy, and peace in the world. And I promise to do my best to give you all of that and more. Thank you for choosing me, for staying, and for loving me in ways I never thought I deserved.

Happy birthday, my love. Hereâ€™s to you, to us, and to a lifetime of celebrating together.`, // <-- string
};
/* ===================== end CONFIG ===================== */

/* Wait for the DOM to be ready before running any script */
document.addEventListener('DOMContentLoaded', () => {

  /* ---------- STATE ---------- */
  let audioCtx = null;
  let masterGain = null;
  let mediaSources = [];
  let gainNodes = [];
  let setIndex = 0;
  let photoIndex = 0;
  let isMuted = false;
  let galleryInterval = null;
  const PHOTOS_PER_SET = 4;
  const CROSSFADE_TIME = 3.0; // Start next song 3s before current one ends

  /* ---------- ELEMENTS (Fixed IDs) ---------- */
  const intro = document.getElementById('intro-screen');
  const startBtn = document.getElementById('start-btn');
  const app = document.getElementById('app');
  const galleryEl = document.getElementById('gallery');
  const captionEl = document.getElementById('caption');
  const typedEl = document.getElementById('typed');
  const letterBox = document.getElementById('letterBox');
  const downloadPdf = document.getElementById('downloadPdf');
  const muteBtn = document.getElementById('muteBtn');
  const finalOverlay = document.getElementById('finalOverlay');
  const finalClose = document.getElementById('finalClose');
  const bgDecor = document.getElementById('bg-decor');

  /* ---------- PREPARE audio elements ---------- */
  const audioEls = CONFIG.songs.map((s, i) => {
    const el = document.getElementById(`audio-song-${i+1}`);
    el.src = s.file;
    el.preload = 'auto';
    el.crossOrigin = "anonymous";
    return el;
  });
  const voiceEl = document.getElementById('audio-voice');
  if (CONFIG.voiceNote) {
    voiceEl.src = CONFIG.voiceNote;
    voiceEl.preload = 'auto';
  }

  /* ---------- WebAudio setup for crossfade ---------- */
  function initAudioContext() {
    if (audioCtx) return;
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = isMuted ? 0 : 1;
      masterGain.connect(audioCtx.destination);

      audioEls.forEach((audioEl, idx) => {
        const src = audioCtx.createMediaElementSource(audioEl);
        const g = audioCtx.createGain();
        g.gain.value = 0; // Start all silent
        src.connect(g);
        g.connect(masterGain);
        mediaSources[idx] = src;
        gainNodes[idx] = g;
      });
    } catch (e) {
      console.error("Web Audio API is not supported in this browser or failed to init.", e);
    }
  }

  function crossfadeTo(index, fadeSec = 2.0) {
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    gainNodes.forEach((g, idx) => {
      try {
        g.gain.cancelScheduledValues(now);
        g.gain.setValueAtTime(g.gain.value, now);
        const targetValue = (idx === index) ? 1.0 : 0.0;
        g.gain.linearRampToValueAtTime(targetValue, now + fadeSec);
      } catch (err) {
        console.warn("Error during crossfade node.", err);
      }
    });
  }

  function handleAudioError(e, index) {
    console.error(`Error playing audio file: ${CONFIG.songs[index]?.file || 'voice note'}`, e);
    // You could show a user-facing error here if desired
  }

  /* ---------- Photo Gallery Rendering & Cycle ---------- */
  function renderInitialSet() {
    galleryEl.innerHTML = "";
    const set = CONFIG.photoSets[setIndex] || [];
    for (let i = 0; i < PHOTOS_PER_SET; i++) {
      const img = document.createElement('img');
      img.className = 'photo';
      img.alt = CONFIG.captions?.[setIndex]?.[i] || `photo-${setIndex+1}-${i+1}`;
      img.src = set[i] || "";
      if (i === 0) {
          img.classList.add('active');
      }
      galleryEl.appendChild(img);
    }
    captionEl.textContent = CONFIG.captions?.[setIndex]?.[0] || "";
  }

  function startPhotoCycler() {
    const interval = 4000;
    const photos = Array.from(galleryEl.querySelectorAll('.photo'));

    galleryInterval = setInterval(() => {
      // 1. Increment photo index
      photoIndex = (photoIndex + 1) % PHOTOS_PER_SET;

      // 2. Check if we wrapped around to a new set
      if (photoIndex === 0) {
        setIndex = (setIndex + 1) % CONFIG.photoSets.length;
        
        // --- SEAMLESS UPDATE ---
        photos.forEach((img, i) => {
          img.src = CONFIG.photoSets[setIndex]?.[i] || "";
          img.alt = CONFIG.captions[setIndex]?.[i] || "";
          img.style.transform = "scale(1) translateY(0)";
        });
      }

      // 3. Update active class and caption
      photos.forEach((p, idx) => {
        p.classList.toggle('active', idx === photoIndex);
      });
      captionEl.textContent = CONFIG.captions?.[setIndex]?.[photoIndex] || "";

      // 4. Per-photo narration (if provided)
      const navFile = (CONFIG.photoNarrations?.[setIndex]) ? CONFIG.photoNarrations[setIndex][photoIndex] : null;
      if (navFile) {
        const narr = new Audio(navFile);
        narr.play().catch((e) => handleAudioError(e, 'narration'));
      }

    }, interval);
  }

  /* ---------- Floating petals, hearts, glow ---------- */
  function startFloatingParticles() {
    const symbols = ["ðŸ’—","ðŸ’ž","ðŸŒ¸","ðŸ’–","ðŸŒ¹"];
    function spawnSymbol() {
      const el = document.createElement('span');
      el.className = 'float';
      el.textContent = symbols[Math.floor(Math.random()*symbols.length)];
      el.style.left = Math.random()*100 + "vw";
      el.style.top = (Math.random()*8 - 8) + "vh";
      el.style.fontSize = (12 + Math.random()*24) + "px";
      el.style.opacity = (0.6 + Math.random()*0.4);
      el.style.transition = "transform 10s linear, opacity 10s linear";
      document.body.appendChild(el);
      
      requestAnimationFrame(()=> {
          el.style.transform = `translateY(${110 + Math.random()*30}vh) rotate(${Math.random()*720}deg)`;
      });
      setTimeout(()=> el.remove(), 10500);
    }
    setInterval(spawnSymbol, 330);

    function spawnGlow() {
      const d = document.createElement('div');
      d.className = 'glowDot';
      d.style.left = Math.random()*100 + "vw";
      d.style.top = Math.random()*100 + "vh";
      bgDecor.appendChild(d);

      requestAnimationFrame(() => {
        d.style.opacity = (0.15 + Math.random() * 0.6);
        setTimeout(() => {
          d.style.opacity = 0;
        }, 8000 + Math.random() * 2000);
      });
      
      setTimeout(()=> d.remove(), 11000);
    }
    setInterval(spawnGlow, 700);
  }

  /* ---------- Typewriter (letter) ---------- */
  function typeWriter(text, speed=28, done) {
    typedEl.innerHTML = "";
    let i = 0;
    (function step(){
      if (i < text.length) {
        typedEl.innerHTML += text.charAt(i++);
        setTimeout(step, speed + Math.random()*12);
      } else {
        if (typeof done === "function") done();
      }
    })();
  }

  /* ---------- Confetti / petals finale ---------- */
  function burstConfetti() {
    const canvas = document.createElement('canvas'); 
    canvas.style.position='fixed'; canvas.style.left=0; canvas.style.top=0; 
    canvas.style.zIndex=9999; canvas.style.pointerEvents='none';
    document.body.appendChild(canvas); canvas.width = innerWidth; canvas.height = innerHeight;
    const ctx = canvas.getContext('2d');
    const pieces = Array.from({length:220}, ()=>({
      x: Math.random()*canvas.width,
      y: -Math.random()*canvas.height,
      vx: (Math.random()-0.5)*6,
      vy: 2+Math.random()*6,
      size: 6+Math.random()*10,
      color: `hsl(${Math.random()*60+330},80%,65%)`,
      rot: Math.random()*360
    }));
    let t = 0;
    function frame(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      pieces.forEach(p=>{
        p.x += p.vx; p.y += p.vy; p.rot += 6;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
        ctx.fillStyle = p.color; ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size); ctx.restore();
      });
      t++; if(t < 260) requestAnimationFrame(frame); else canvas.remove();
    }
    frame();
  }

  /* ---------- PDF download ---------- */
  downloadPdf.addEventListener('click', ()=>{
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt',format:'letter'});
      doc.setFontSize(14); doc.setFont("Times","Normal");
      const lines = doc.splitTextToSize(CONFIG.letter, 520);
      doc.text(lines, 40, 60);
      doc.save("Happy_Birthday_Letter.pdf");
    } catch (e) {
      console.error("jsPDF failed:", e);
      alert("Error: Could not generate PDF. Please try again.");
    }
  });

  /* ---------- Mute toggle ---------- */
  muteBtn.addEventListener('click', ()=>{
    isMuted = !isMuted;
    if (masterGain) {
      masterGain.gain.value = isMuted ? 0 : 1;
    }
    muteBtn.textContent = isMuted ? "Unmute" : "Mute";
  });

  /* ---------- REFACTORED: Play all songs sequentially ---------- */
  function playSong(index) {
    if (index >= audioEls.length) {
      onPlaylistComplete();
      return;
    }

    const audioEl = audioEls[index];
    let hasTriggeredNext = false;

    const onTimeUpdate = () => {
      if (hasTriggeredNext) return;
      if (audioEl.duration && (audioEl.duration - audioEl.currentTime) < CROSSFADE_TIME) {
        hasTriggeredNext = true;
        audioEl.removeEventListener('timeupdate', onTimeUpdate);
        playSong(index + 1); // start next
      }
    };

    audioEl.onended = () => {
      audioEl.removeEventListener('timeupdate', onTimeUpdate);
      if (!hasTriggeredNext) {
        playSong(index + 1);
      }
    };

    audioEl.addEventListener('timeupdate', onTimeUpdate);
    audioEl.currentTime = 0;
    audioEl.play().catch((e) => handleAudioError(e, index));
    crossfadeTo(index, 2.0);
  }

  /* ---------- After playlist completes ---------- */
  function onPlaylistComplete(){
    burstConfetti();
    finalOverlay.classList.add('show');
    finalOverlay.setAttribute('aria-hidden','false');
  }
  
  /* ---------- Final overlay close button ---------- */
  finalClose.addEventListener('click', ()=> {
    finalOverlay.classList.remove('show');
    finalOverlay.setAttribute('aria-hidden','true');
  });

  /* ---------- Orchestration / Start button ---------- */
  startBtn.addEventListener('click', async () => {
    initAudioContext();
    if (audioCtx && audioCtx.state === 'suspended') {
      try { await audioCtx.resume(); } catch(e){}
    }

    // Unlock playback permission
    for (let i = 0; i < audioEls.length; i++) {
      try { await audioEls[i].play(); audioEls[i].pause(); audioEls[i].currentTime = 0; } 
      catch(e){ handleAudioError(e, i); }
    }
    if (CONFIG.voiceNote) {
      try { await voiceEl.play(); voiceEl.pause(); voiceEl.currentTime = 0; } 
      catch(e){ handleAudioError(e, 'voice'); }
    }

    // show app & start visuals
    intro.style.opacity = 0;
    intro.setAttribute('aria-hidden', 'true');
    setTimeout(()=> {
      intro.style.display = 'none';
      app.classList.remove('hidden');
      app.setAttribute('aria-hidden', 'false');
    }, 600);

    // render first photo set & start cycles
    renderInitialSet();
    startPhotoCycler();
    startFloatingParticles();

    // type letter while music plays
    typeWriter(CONFIG.letter, 28, ()=>{
      if (CONFIG.voiceNote) {
        voiceEl.play().catch((e) => handleAudioError(e, 'voice'));
      }
    });

    // finally start music chain
    playSong(0);
  });

}); // End DOMContentLoaded
</script>
</body>
</html>
