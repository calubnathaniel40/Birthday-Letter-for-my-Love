/* ===================== CONFIG - Add your content here ===================== */
const CONFIG = {
  songs: [
    {file: "song1.mp3", title: "123 â€” Over October"},
    {file: "song2.mp3", title: "Until I Found Her"},
    {file: "song3.mp3", title: "Ikaw Pa Rin Ang Pipiliin Ko"},
    {file: "song4.mp3", title: "Leonora"}
  ],

  photos: [
    {src: "set1-1.jpg", caption: "EO yarn?"},
    {src: "set1-2.jpg", caption: "Road trip memories"},
    {src: "set1-3.jpg", caption: "Bleehhbleehhh"},
    {src: "set1-4.jpg", caption: "EK Moments"},
    {src: "set2-1.jpg", caption: "Random galaa"},
    {src: "set2-2.jpg", caption: "Picture muna kayo?!"},
    {src: "set2-3.jpg", caption: "Birthdate?"},
    {src: "set2-4.jpg", caption: "Watch your sport"},
  ],
  
  voiceNote: "voice.mp3",
  
  letter: `Happy Birthday, my baby!

Dear, Daniele Loise T. Guerta,

Happy birthday, my babyyy. I hope today fills your heart with peace, joy, and warmth because thatâ€™s exactly what you give to me every single day. I want this letter to be something you can come back to whenever you need to feel loved, safe, and reminded of how special you are not just to me, but to everyone whoâ€™s lucky enough to know you.
When I look back to the day we met in November 2024, I still remember how I felt. I didnâ€™t know that moment would change my life in such a deep way. You came into my world quietly, like a gentle wave, and suddenly everything felt lighter. I didnâ€™t expect that someone could make my days brighter just by being around, but you did. There was something about you the way you smiled, the way you talked, the way your presence made things feel calm yet exciting at the same time.
Then came January 12, the day we became official. That date will always hold a special place in my heart. It wasnâ€™t just the start of a relationship. It was the start of a beautiful journey with someone I truly cared about. Since then, every day has been a chapter Iâ€™m proud to live. There were moments filled with laughter, some filled with silence, and some where we learned more about each other and what love really means. Through it all, Iâ€™ve never stopped feeling lucky to have you.
Youâ€™ve become my favorite person to talk to, my safe space when I feel lost, and the one I look forward to spending my days with. You have this way of making even ordinary days feel meaningful. Whether weâ€™re talking about random things or just sitting quietly together, it always feels right. You make me feel seen and understood, and thatâ€™s something not everyone gets to experience.

As I write this, I canâ€™t help but think about how much youâ€™ve grown and how proud I am of you. Youâ€™ve gone through challenges, but you never gave up. You stayed strong, even when life tried to test you. You inspire me in ways you might not even realize. You have a kind heart, a brave soul, and a beautiful mind. You deserve every good thing that life has to offer.

On your birthday, I want to wish you everything your heart desires. I wish you happiness that lasts, dreams that come true, and peace that stays within you no matter what happens. I hope every prayer you whisper is heard and answered in the best way possible. You deserve a life full of love, success, and calm moments where you can finally breathe and say, â€œI made it.â€

I know life will not always be easy. There will be days when things feel heavy and the world feels unfair. But I want you to remember that you are not alone. You are strong enough to get through anything, and I will always be right here to remind you of that. Iâ€™ll be beside you through every storm, holding your hand and reminding you that better days are always ahead. Youâ€™ve handled so much with grace already, and I believe in your strength more than you might believe in it yourself.

Youâ€™ve shown me what love really means. Itâ€™s not just about saying â€œI love you,â€ itâ€™s about showing up, being patient, and growing together. Weâ€™ve had our ups and downs, and thatâ€™s what makes what we have real. Itâ€™s not perfect, but itâ€™s ours. Every misunderstanding, every small fight, every sweet moment afterward it all adds up to something real and worth fighting for. Youâ€™ve taught me that love is not about never having problems; itâ€™s about choosing each other again and again, even when itâ€™s not easy.

Sometimes I find myself just sitting and thinking about how far weâ€™ve come since we first met. It hasnâ€™t been that long, but it already feels like weâ€™ve built something strong and beautiful. Youâ€™ve become a part of my daily thoughts, my prayers, and my future dreams. I imagine us celebrating more birthdays together, laughing about old memories, and creating new ones as we grow.

Iwant you to know how proud I am of you not just for the big things youâ€™ve achieved, but also for the little things you do every day. The way you care for others, the way you stay kind even when people arenâ€™t, the way you keep moving forward even when youâ€™re tired all of that shows how beautiful your heart truly is. You have this quiet strength that makes people around you feel safe. You have this warmth that makes any place feel like home.

Sometimes I wish I could take away all your worries and struggles. I wish I could protect you from every pain and make your days full of peace. But I also know that every challenge you face shapes you into the amazing person youâ€™re becoming. So instead, Iâ€™ll just be here, loving you through everything, cheering you on, and reminding you that you are never alone.

I pray that life gives you endless reasons to smile. I hope that your dreams come true not just the big ones, but also the small, quiet wishes you keep in your heart. I hope you never lose the courage to chase what makes you happy. I hope you keep believing in yourself, even when things donâ€™t go as planned. You have so much potential, and I know youâ€™ll achieve beautiful things one day.

Youâ€™ve always been the type of person who brings light wherever you go. I love how you make people feel seen and loved. Iâ€™ve seen the way your laughter changes the mood in a room, the way your kindness touches lives without even trying. You have a heart thatâ€™s rare, and I feel lucky to be the one who gets to experience it the most.

I want you to remember something, my love you donâ€™t have to have everything figured out right now. You donâ€™t have to be perfect. You donâ€™t have to hide when you feel weak or tired. Itâ€™s okay to rest, itâ€™s okay to cry, itâ€™s okay to ask for help. You are human, and thatâ€™s what makes you beautiful. What matters is that you always get back up, and you keep going, no matter how hard it gets. And when the world feels too much, I hope you always remember that you have me. You have someone who believes in you endlessly. You have someone who will always choose you, no matter how hard life gets. You have someone who wants to grow with you, not just in the easy moments, but also through the storms.

On your birthday, I want to thank you for being in my life. Thank you for your love, your patience, and your effort. Thank you for the times you stayed even when things got hard. Thank you for the way you always try to understand me. ThankD_Nthank you for being the reason behind my smiles, my peace, and my strength. Youâ€™ve become such an important part of my life, and I canâ€™t imagine my days without you in them.
I love how weâ€™ve built something honest and true. Weâ€™re not perfect, but what we have is real. Weâ€™ve learned to understand each other, to communicate, to listen, and to grow. Thatâ€™s what love is about not giving up when things get tough, but choosing to stay and make things better together. I want to keep doing that with you, again and again, because youâ€™re worth every effort and every moment.
When I look at you, I see my favorite person in the world. You are beautiful, inside and out. Youâ€™re the kind of person who deserves the world and even more. I hope this year gives you more reasons to be proud of yourself. I hope it reminds you of how much youâ€™ve grown and how far youâ€™ve come. Youâ€™ve made it through so much already, and I know youâ€™ll keep moving forward with the same strength and grace.

I wish that the year ahead brings you peace in your heart. I wish for more laughter, more blessings, and more memories that make you smile. I wish for your days to be filled with love from me, from your family, from your friends, and from life itself. You deserve to be surrounded by love and positivity always.

Youâ€™ve shown me how powerful love can be. Youâ€™ve made me realize that love isnâ€™t just about big gestures or fancy words. Itâ€™s about consistency, patience, and choosing each other even when things arenâ€™t easy. I love how weâ€™ve learned to support one another and how we continue to grow stronger together. Thatâ€™s something Iâ€™ll never take for granted.

So on this special day, my babyyy, I wish you the happiest birthday ever. I hope this year brings you joy that stays, blessings that overflow, and moments that remind you of how truly special you are. I hope you keep shining with the same light that first caught my heart. And I hope that no matter what happens, youâ€™ll always know that you are loved deeply and endlessly by me.

Thank you for being my person, for giving my life meaning, and for showing me what real love feels like. Iâ€™ll keep loving you every day, in every way I can. Youâ€™re my always, and Iâ€™m so grateful I get to share this journey with you.
Happy birthday, my babyyy. Hereâ€™s to you, to us, and to many more years of love, laughter, and memories weâ€™ll treasure forever.

Love,
Nathan 
`,
};
/* ===================== end CONFIG ===================== */

document.addEventListener('DOMContentLoaded', () => {

  /* ---------- STATE ---------- */
  let isMuted = false;
  let letterChars = []; // Array to hold all letter <span> elements
  let letterBoxTop; // To know when the letter starts
  let letterBoxHeight; // To know how long the letter is
  let viewportHeight; // To know the screen height

  /* ---------- ELEMENTS ---------- */
  const intro = document.getElementById('intro-screen');
  const startBtn = document.getElementById('start-btn');
  const app = document.getElementById('app');
  
  const letterBox = document.getElementById('letterBox');
  const letterTextEl = document.getElementById('letter-text');
  const galleryCarouselEl = document.querySelector('.gallery-carousel');
  const canvas = document.getElementById('constellation-bg');
  
  const downloadPdf = document.getElementById('downloadPdf');
  const muteBtn = document.getElementById('muteBtn');
  const finalOverlay = document.getElementById('finalOverlay');
  const finalClose = document.getElementById('finalClose');

  /* ---------- AUDIO ---------- */
  const audioEls = CONFIG.songs.map((s, i) => {
    const el = document.getElementById(`audio-song-${i+1}`);
    if (el) { el.src = s.file; el.preload = 'auto'; el.crossOrigin = "anonymous"; }
    return el;
  }).filter(el => el != null);

  const voiceEl = document.getElementById('audio-voice');
  if (CONFIG.voiceNote && voiceEl) {
    voiceEl.src = CONFIG.voiceNote;
    voiceEl.preload = 'auto';
  }
  
  function handleAudioError(e, index) {
    console.error(`Error playing audio file: ${CONFIG.songs[index]?.file || 'voice note'}`, e);
  }
  
  function playSong(index) {
    if (index >= audioEls.length) {
      onPlaylistComplete();
      return;
    }
    const audioEl = audioEls[index];
    if (!audioEl) {
      playSong(index + 1);
      return;
    }
    audioEl.onended = () => playSong(index + 1);
    audioEl.onerror = (e) => {
        handleAudioError(e, index);
        playSong(index + 1);
    };
    audioEl.currentTime = 0;
    audioEl.muted = isMuted;
    audioEl.play().catch((e) => handleAudioError(e, index));
  }

  /* ---------- NEW: Professional Constellation Background --- */
  function initConstellation() {
    const ctx = canvas.getContext('2d');
    let width, height, particles;
    
    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
      particles = Array.from({length: 100}, () => ({
        x: Math.random() * width,
        y: Math.random() * height,
        vx: Math.random() * 0.2 - 0.1, // Slow horizontal drift
        vy: Math.random() * 0.4 - 0.2, // Slow vertical drift
        radius: 1 + Math.random() * 1.5 // Small dots
      }));
    }
    
    function draw() {
      ctx.clearRect(0, 0, width, height);
      ctx.fillStyle = 'rgba(255, 219, 230, 0.5)'; // Soft pink dots
      ctx.strokeStyle = 'rgba(255, 192, 203, 0.15)'; // Faint pink lines
      
      particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        
        // Wrap particles around edges
        if (p.x < 0) p.x = width;
        if (p.x > width) p.x = 0;
        if (p.y < 0) p.y = height;
        if (p.y > height) p.y = 0;
        
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        ctx.fill();
      });
      
      // Draw connecting lines
      for (let i = 0; i < particles.length; i++) {
        for (let j = i + 1; j < particles.length; j++) {
          const dx = particles[i].x - particles[j].x;
          const dy = particles[i].y - particles[j].y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          
          if (dist < 120) { // Connect if close
            ctx.beginPath();
            ctx.moveTo(particles[i].x, particles[i].y);
            ctx.lineTo(particles[j].x, particles[j].y);
            ctx.stroke();
          }
        }
      }
      
      requestAnimationFrame(draw);
    }
    
    window.addEventListener('resize', resize);
    resize();
    draw();
  }

  /* --- NEW: Populate page with gallery and letter spans --- */
  function populateContent() {
    // 1. Populate Gallery
    CONFIG.photos.forEach(photo => {
      const item = document.createElement('div');
      item.className = 'carousel-item';
      item.innerHTML = `<img src="${photo.src}" alt="${photo.caption}">`;
      galleryCarouselEl.appendChild(item);
    });

    // 2. Populate Letter
    const letter = CONFIG.letter;
    let html = '';
    for (let i = 0; i < letter.length; i++) {
      const char = letter[i];
      if (char === '\n') {
        html += '<span class="letter-char newline"></span>';
      } else {
        html += `<span class="letter-char">${char}</span>`;
      }
    }
    letterTextEl.innerHTML = html;
    letterChars = document.querySelectorAll('.letter-char');
  }

  /* --- NEW: Setup Scroll Listener --- */
  function setupScrollListener() {
    // Get dimensions *after* content is populated
    viewportHeight = window.innerHeight;
    letterBoxTop = letterBox.offsetTop;
    letterBoxHeight = letterBox.offsetHeight;

    // Listen for scroll events
    window.addEventListener('scroll', handleScroll, { passive: true });
  }

  function handleScroll() {
    const scrollY = window.scrollY;

    // --- Letter Reveal Logic ---
    // Calculate how far *into* the letterbox the user has scrolled
    // 0 = top of letterbox is at bottom of screen
    // 1 = bottom of letterbox is at top of screen
    const scrollStart = letterBoxTop - viewportHeight;
    const scrollEnd = letterBoxTop + letterBoxHeight - (viewportHeight * 0.25); // End sooner
    
    // Calculate the reveal progress (0 to 1)
    let progress = (scrollY - scrollStart) / (scrollEnd - scrollStart);
    progress = Math.max(0, Math.min(1, progress)); // Clamp between 0 and 1
    
    if (isNaN(progress)) progress = 0;

    // How many characters to reveal
    const charsToReveal = Math.floor(letterChars.length * progress);
    
    // Loop through and add/remove class
    letterChars.forEach((char, index) => {
      if (index < charsToReveal) {
        char.classList.add('revealed');
      } else {
        char.classList.remove('revealed');
      }
    });

    // --- Voice Note Logic ---
    // If progress is 1 (end of letter) and voice note exists, play it.
    if (progress === 1 && voiceEl && voiceEl.paused) {
      if (CONFIG.voiceNote) {
        voiceEl.play().catch((e) => handleAudioError(e, 'voice'));
      }
      // Remove scroll listener to prevent re-triggering
      window.removeEventListener('scroll', handleScroll);
    }
  }

  /* --- PDF download (using html2canvas) --- */
  downloadPdf.addEventListener('click', ()=>{
    const originalText = downloadPdf.textContent;
    downloadPdf.textContent = "Loading...";
    
    try {
      if (typeof jsPDF === 'undefined' || typeof html2canvas === 'undefined') {
        alert("Error: PDF libraries not loaded.");
        downloadPdf.textContent = originalText;
        return;
      }

      const { jsPDF } = window.jspdf;
      
      // We must render the *entire* letter, not just the visible part
      html2canvas(letterBox, {
          scale: 2,
          useCORS: true,
          backgroundColor: null,
          onclone: (doc) => {
            // Force the letter to be fully visible and rendered
            doc.getElementById('letter-text').style.height = 'auto';
            const chars = doc.querySelectorAll('.letter-char');
            chars.forEach(char => char.classList.add('revealed'));
          }
      }).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: 'letter' });
          
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          const imgWidth = canvas.width;
          const imgHeight = canvas.height;
          
          const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
          const imgX = (pdfWidth - imgWidth * ratio) / 2;
          
          pdf.addImage(imgData, 'PNG', imgX, 10, imgWidth * ratio, imgHeight * ratio);
          pdf.save("Happy_Birthday_Letter.pdf");
          downloadPdf.textContent = originalText;
      }).catch(e => {
          console.error("html2canvas failed:", e);
          alert("Error: Could not generate PDF.");
          downloadPdf.textContent = originalText;
      });

    } catch (e) {
      console.error("PDF generation failed:", e);
      alert("Error: Could not generate PDF. Please try again.");
      downloadPdf.textContent = originalText;
    }
  });

  /* --- Mute toggle --- */
  muteBtn.addEventListener('click', ()=>{
    isMuted = !isMuted;
    audioEls.forEach(el => { if(el) el.muted = isMuted; });
    if (voiceEl) { voiceEl.muted = isMuted; }
    muteBtn.textContent = isMuted ? "Unmute" : "Mute";
  });

  /* --- Final overlay --- */
  function onPlaylistComplete(){
    // Only show if not already shown
    if (!finalOverlay.classList.contains('show')) {
        burstConfetti(); // You can re-use the confetti function
        finalOverlay.classList.add('show');
        finalOverlay.setAttribute('aria-hidden','false');
    }
  }
  
  finalClose.addEventListener('click', ()=> {
    finalOverlay.classList.remove('show');
    finalOverlay.setAttribute('aria-hidden','true');
  });

  // Confetti (re-used from old code)
  function burstConfetti() {
    const canvas = document.createElement('canvas');  
    canvas.style.position='fixed'; canvas.style.left=0; canvas.style.top=0;  
    canvas.style.zIndex=9999; canvas.style.pointerEvents='none';
    document.body.appendChild(canvas); canvas.width = innerWidth; canvas.height = innerHeight;
    const ctx = canvas.getContext('2d');
    const pieces = Array.from({length:220}, ()=>({
      x: Math.random()*canvas.width, y: -Math.random()*canvas.height,
      vx: (Math.random()-0.5)*6, vy: 2+Math.random()*6,
      size: 15 + Math.random() * 15,
      color: `hsl(${Math.random()*60+330}, 80%, 65%)`, rot: Math.random()*360
    }));
    let t = 0;
    function frame(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      pieces.forEach(p=>{
        p.x += p.vx; p.y += p.vy; p.rot += 3;
        ctx.save();
        ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
        ctx.font = `${p.size}px Arial`; ctx.fillStyle = p.color;
        ctx.globalAlpha = p.y < 0 ? 0 : 1;
        ctx.fillText('ðŸ’–', -p.size/2, p.size/2);
        ctx.restore();
      });
      t++; if(t < 300) requestAnimationFrame(frame); else canvas.remove();
    }
    frame();
  }

  /* ---------- Orchestration / Start button ---------- */
  startBtn.addEventListener('click', async () => {
    // 1. Unlock playback permission
    for (const el of audioEls) {
      try { await el.play(); el.pause(); el.currentTime = 0; }  
      catch(e){ handleAudioError(e, audioEls.indexOf(el)); }
    }
    if (CONFIG.voiceNote && voiceEl) {
      try { await voiceEl.play(); voiceEl.pause(); voiceEl.currentTime = 0; }  
      catch(e){ handleAudioError(e, 'voice'); }
    }

    // 2. show app & start visuals
    intro.style.opacity = 0;
    intro.setAttribute('aria-hidden', 'true');
    setTimeout(()=> {
      intro.style.display = 'none';
      app.classList.remove('hidden');
      // Must re-enable scrolling on the body
      document.body.style.overflow = 'auto';
      // Add 'loaded' class to fade in the app
      app.classList.add('loaded');
    }, 600);
    
    // 3. Populate the content
    populateContent();

    // 4. Start the new background
    initConstellation();

    // 5. Start the scroll listener
    setupScrollListener();
    
    // 6. Start the music
    playSong(0);
  });
  
  // On page load, disable scrolling until 'Start' is clicked
  document.body.style.overflow = 'hidden';

}); // End DOMContentLoaded
