/* ===================== CONFIG - Add your content here ===================== */
const CONFIG = {
  songs: [
    {file: "song1.mp3", title: "123 — Over October"},
    {file: "song2.mp3", title: "Until I Found Her"},
    {file: "song3.mp3", title: "Ikaw Pa Rin Ang Pipiliin Ko"},
    {file: "song4.mp3", title: "Leonora"}
  ],

  // NEW SIMPLIFIED PHOTO GALLERY
  // Just add your image files and captions here.
  photos: [
    {src: "set1-1.jpg", caption: "EO yarn?"},
    {src: "set1-2.jpg", caption: "Road trip memories"},
    {src: "set1-3.jpg", caption: "Bleehhbleehhh"},
    {src: "set1-4.jpg", caption: "EK Moments"},
    {src: "set2-1.jpg", caption: "Random galaa"},
    {src: "set2-2.jpg", caption: "Picture muna kayo?!"},
    {src: "set2-3.jpg", caption: "Birthdate?"},
    {src: "set2-4.jpg", caption: "Watch your sport"},
    // Add as many more as you like
  ],
  
  voiceNote: "voice.mp3", // optional; place voice.mp3 or leave blank ""
  
  letter: `Happy Birthday, my baby!


Dear, Daniele Loise T. Guerta,

Happy birthday, my babyyy. I hope today fills your heart with peace, joy, and warmth because that’s exactly what you give to me every single day. I want this letter to be something you can come back to whenever you need to feel loved, safe, and reminded of how special you are not just to me, but to everyone who’s lucky enough to know you.
When I look back to the day we met in November 2024, I still remember how I felt. I didn’t know that moment would change my life in such a deep way. You came into my world quietly, like a gentle wave, and suddenly everything felt lighter. I didn’t expect that someone could make my days brighter just by being around, but you did. There was something about you the way you smiled, the way you talked, the way your presence made things feel calm yet exciting at the same time.
Then came January 12, the day we became official. That date will always hold a special place in my heart. It wasn’t just the start of a relationship. It was the start of a beautiful journey with someone I truly cared about. Since then, every day has been a chapter I’m proud to live. There were moments filled with laughter, some filled with silence, and some where we learned more about each other and what love really means. Through it all, I’ve never stopped feeling lucky to have you.
You’ve become my favorite person to talk to, my safe space when I feel lost, and the one I look forward to spending my days with. You have this way of making even ordinary days feel meaningful. Whether we’re talking about random things or just sitting quietly together, it always feels right. You make me feel seen and understood, and that’s something not everyone gets to experience.

As I write this, I can’t help but think about how much you’ve grown and how proud I am of you. You’ve gone through challenges, but you never gave up. You stayed strong, even when life tried to test you. You inspire me in ways you might not even realize. You have a kind heart, a brave soul, and a beautiful mind. You deserve every good thing that life has to offer.

On your birthday, I want to wish you everything your heart desires. I wish you happiness that lasts, dreams that come true, and peace that stays within you no matter what happens. I hope every prayer you whisper is heard and answered in the best way possible. You deserve a life full of love, success, and calm moments where you can finally breathe and say, “I made it.”

I know life will not always be easy. There will be days when things feel heavy and the world feels unfair. But I want you to remember that you are not alone. You are strong enough to get through anything, and I will always be right here to remind you of that. I’ll be beside you through every storm, holding your hand and reminding you that better days are always ahead. You’ve handled so much with grace already, and I believe in your strength more than you might believe in it yourself.

You’ve shown me what love really means. It’s not just about saying “I love you,” it’s about showing up, being patient, and growing together. We’ve had our ups and downs, and that’s what makes what we have real. It’s not perfect, but it’s ours. Every misunderstanding, every small fight, every sweet moment afterward it all adds up to something real and worth fighting for. You’ve taught me that love is not about never having problems; it’s about choosing each other again and again, even when it’s not easy.

Sometimes I find myself just sitting and thinking about how far we’ve come since we first met. It hasn’t been that long, but it already feels like we’ve built something strong and beautiful. You’ve become a part of my daily thoughts, my prayers, and my future dreams. I imagine us celebrating more birthdays together, laughing about old memories, and creating new ones as we grow.

I want you to know how proud I am of you not just for the big things you’ve achieved, but also for the little things you do every day. The way you care for others, the way you stay kind even when people aren’t, the way you keep moving forward even when you’re tired all of that shows how beautiful your heart truly is. You have this quiet strength that makes people around you feel safe. You have this warmth that makes any place feel like home.

Sometimes I wish I could take away all your worries and struggles. I wish I could protect you from every pain and make your days full of peace. But I also know that every challenge you face shapes you into the amazing person you’re becoming. So instead, I’ll just be here, loving you through everything, cheering you on, and reminding you that you are never alone.

I pray that life gives you endless reasons to smile. I hope that your dreams come true not just the big ones, but also the small, quiet wishes you keep in your heart. I hope you never lose the courage to chase what makes you happy. I hope you keep believing in yourself, even when things don’t go as planned. You have so much potential, and I know you’ll achieve beautiful things one day.

You’ve always been the type of person who brings light wherever you go. I love how you make people feel seen and loved. I’ve seen the way your laughter changes the mood in a room, the way your kindness touches lives without even trying. You have a heart that’s rare, and I feel lucky to be the one who gets to experience it the most.

I want you to remember something, my love you don’t have to have everything figured out right now. You don’t have to be perfect. You don’t have to hide when you feel weak or tired. It’s okay to rest, it’s okay to cry, it’s okay to ask for help. You are human, and that’s what makes you beautiful. What matters is that you always get back up, and you keep going, no matter how hard it gets. And when the world feels too much, I hope you always remember that you have me. You have someone who believes in you endlessly. You have someone who will always choose you, no matter how hard life gets. You have someone who wants to grow with you, not just in the easy moments, but also through the storms.

On your birthday, I want to thank you for being in my life. Thank you for your love, your patience, and your effort. Thank you for the times you stayed even when things got hard. Thank you for the way you always try to understand me. Thank you for being the reason behind my smiles, my peace, and my strength. You’ve become such an important part of my life, and I can’t imagine my days without you in them.
I love how we’ve built something honest and true. We’re not perfect, but what we have is real. We’ve learned to understand each other, to communicate, to listen, and to grow. That’s what love is about not giving up when things get tough, but choosing to stay and make things better together. I want to keep doing that with you, again and again, because you’re worth every effort and every moment.
When I look at you, I see my favorite person in the world. You are beautiful, inside and out. You’re the kind of person who deserves the world and even more. I hope this year gives you more reasons to be proud of yourself. I hope it reminds you of how much you’ve grown and how far you’ve come. You’ve made it through so much already, and I know you’ll keep moving forward with the same strength and grace.

I wish that the year ahead brings you peace in your heart. I wish for more laughter, more blessings, and more memories that make you smile. I wish for your days to be filled with love from me, from your family, from your friends, and from life itself. You deserve to be surrounded by love and positivity always.

You’ve shown me how powerful love can be. You’ve made me realize that love isn’t just about big gestures or fancy words. It’s about consistency, patience, and choosing each other even when things aren’t easy. I love how we’ve learned to support one another and how we continue to grow stronger together. That’s something I’ll never take for granted.

So on this special day, my babyyy, I wish you the happiest birthday ever. I hope this year brings you joy that stays, blessings that overflow, and moments that remind you of how truly special you are. I hope you keep shining with the same light that first caught my heart. And I hope that no matter what happens, you’ll always know that you are loved deeply and endlessly by me.

Thank you for being my person, for giving my life meaning, and for showing me what real love feels like. I’ll keep loving you every day, in every way I can. You’re my always, and I’m so grateful I get to share this journey with you.
Happy birthday, my babyyy. Here’s to you, to us, and to many more years of love, laughter, and memories we’ll treasure forever.

Love,
Nathan 
`,
};
/* ===================== end CONFIG ===================== */

document.addEventListener('DOMContentLoaded', () => {

  /* ---------- STATE ---------- */
  let audioCtx = null;
  let masterGain = null;
  let mediaSources = [];
  let gainNodes = [];
  let isMuted = false;
  let galleryInterval = null;
  const CROSSFADE_TIME = 3.0; // Start next song 3s before current one ends

  /* ---------- ELEMENTS (Fixed IDs) ---------- */
  const intro = document.getElementById('intro-screen');
  const startBtn = document.getElementById('start-btn');
  const app = document.getElementById('app');
  
  // NEW Gallery Elements
  const galleryCard = document.getElementById('gallery-card');
  const galleryImage = document.getElementById('gallery-image');
  const galleryCaption = document.getElementById('gallery-caption');

  const typedEl = document.getElementById('typed');
  const letterBox = document.getElementById('letterBox');
  const downloadPdf = document.getElementById('downloadPdf');
  const muteBtn = document.getElementById('muteBtn');
  const finalOverlay = document.getElementById('finalOverlay');
  const finalClose = document.getElementById('finalClose');
  const bgDecor = document.getElementById('bg-decor');

  /* ---------- PREPARE audio elements ---------- */
  const audioEls = CONFIG.songs.map((s, i) => {
    const el = document.getElementById(`audio-song-${i+1}`);
    el.src = s.file;
    el.preload = 'auto';
    el.crossOrigin = "anonymous";
    return el;
  });
  const voiceEl = document.getElementById('audio-voice');
  if (CONFIG.voiceNote) {
    voiceEl.src = CONFIG.voiceNote;
    voiceEl.preload = 'auto';
  }

  /* ---------- WebAudio setup for crossfade ---------- */
  function initAudioContext() {
    if (audioCtx) return;
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = isMuted ? 0 : 1;
      masterGain.connect(audioCtx.destination);

      audioEls.forEach((audioEl, idx) => {
        const src = audioCtx.createMediaElementSource(audioEl);
        const g = audioCtx.createGain();
        g.gain.value = 0; // Start all silent
        src.connect(g);
        g.connect(masterGain);
        mediaSources[idx] = src;
        gainNodes[idx] = g;
      });
    } catch (e) {
      console.error("Web Audio API is not supported in this browser or failed to init.", e);
    }
  }

  function crossfadeTo(index, fadeSec = 2.0) {
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    gainNodes.forEach((g, idx) => {
      try {
        g.gain.cancelScheduledValues(now);
        g.gain.setValueAtTime(g.gain.value, now);
        const targetValue = (idx === index) ? 1.0 : 0.0;
        g.gain.linearRampToValueAtTime(targetValue, now + fadeSec);
      } catch (err) {
        console.warn("Error during crossfade node.", err);
      }
    });
  }

  function handleAudioError(e, index) {
    console.error(`Error playing audio file: ${CONFIG.songs[index]?.file || 'voice note'}`, e);
  }

  /* ---------- NEW 3D Flip Card Gallery Logic ---------- */
  function startFlipCardGallery() {
    let photoIndex = 0;
    const interval = 4500; // Time per photo

    function updateCard(index) {
      const photo = CONFIG.photos[index];
      if (!photo) return;
      
      // 1. Fade card out
      galleryCard.classList.remove('active');
      
      // 2. After a short delay, update the content
      setTimeout(() => {
        galleryImage.src = photo.src;
        galleryImage.alt = photo.caption;
        galleryCaption.textContent = photo.caption;
        
        // 3. Make sure card is facing front
        galleryCard.classList.remove('is-flipped');
        
        // 4. Fade card back in
        setTimeout(() => {
            galleryCard.classList.add('active');
        }, 100); // Short delay to allow CSS to see change
        
      }, 1000); // Wait for fade-out to finish
    }

    // Click to flip the card
    galleryCard.parentElement.addEventListener('click', () => {
      galleryCard.classList.toggle('is-flipped');
    });

    // Start the slideshow
    updateCard(photoIndex); // Show first card
    
    galleryInterval = setInterval(() => {
      photoIndex = (photoIndex + 1) % CONFIG.photos.length;
      updateCard(photoIndex);
    }, interval);
  }

  /* ---------- Floating petals, hearts, glow ---------- */
  function startFloatingParticles() {
    // Added more cute symbols
    const symbols = ["💗","💞","🌸","💖","🌹", "✨", "🌱"];
    function spawnSymbol() {
      const el = document.createElement('span');
      el.className = 'float';
      el.textContent = symbols[Math.floor(Math.random()*symbols.length)];
      el.style.left = Math.random()*100 + "vw";
      el.style.top = (Math.random()*8 - 8) + "vh";
      el.style.fontSize = (12 + Math.random()*24) + "px";
      el.style.opacity = (0.6 + Math.random()*0.4);
      el.style.transition = "transform 10s linear, opacity 10s linear";
      document.body.appendChild(el);
      
      requestAnimationFrame(()=> {
          el.style.transform = `translateY(${110 + Math.random()*30}vh) rotate(${Math.random()*720}deg)`;
      });
      setTimeout(()=> el.remove(), 10500);
    }
    setInterval(spawnSymbol, 330);

    function spawnGlow() {
      const d = document.createElement('div');
      d.className = 'glowDot';
      d.style.left = Math.random()*100 + "vw";
      d.style.top = Math.random()*100 + "vh";
      bgDecor.appendChild(d);

      requestAnimationFrame(() => {
        d.style.opacity = (0.15 + Math.random() * 0.6);
        setTimeout(() => {
          d.style.opacity = 0;
        }, 8000 + Math.random() * 2000);
      });
      
      setTimeout(()=> d.remove(), 11000);
    }
    setInterval(spawnGlow, 700);
  }

  /* ---------- Typewriter (letter) ---------- */
  function typeWriter(text, speed=28, done) {
    typedEl.innerHTML = "";
    let i = 0;
    (function step(){
      if (i < text.length) {
        // Handle newlines
        if (text.charAt(i) === '\n') {
          typedEl.innerHTML += '<br>';
        } else {
          typedEl.innerHTML += text.charAt(i);
        }
        i++;
        typedEl.scrollTop = typedEl.scrollHeight; // Auto-scroll
        setTimeout(step, speed + Math.random()*12);
      } else {
        typedEl.classList.remove('typing'); // Remove blinking cursor
        if (typeof done === "function") done();
      }
    })();
  }

  /* ---------- NEW "BEST" Confetti / Hearts Finale ---------- */
  function burstConfetti() {
    const canvas = document.createElement('canvas');  
    canvas.style.position='fixed'; canvas.style.left=0; canvas.style.top=0;  
    canvas.style.zIndex=9999; canvas.style.pointerEvents='none';
    document.body.appendChild(canvas); canvas.width = innerWidth; canvas.height = innerHeight;
    const ctx = canvas.getContext('2d');
    const pieces = Array.from({length:220}, ()=>({
      x: Math.random()*canvas.width,
      y: -Math.random()*canvas.height,
      vx: (Math.random()-0.5)*6,
      vy: 2+Math.random()*6,
      size: 15 + Math.random() * 15, // Made hearts bigger
      color: `hsl(${Math.random()*60+330}, 80%, 65%)`, // Pinks and reds
      rot: Math.random()*360
    }));
    let t = 0;
    function frame(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      pieces.forEach(p=>{
        p.x += p.vx; p.y += p.vy; p.rot += 3;
        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(p.rot*Math.PI/180);
        ctx.font = `${p.size}px Arial`; // Use font size for emoji size
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.y < 0 ? 0 : 1; // Fade in at top
        ctx.fillText('💖', -p.size/2, p.size/2); // Draw a heart emoji
        ctx.restore();
      });
      t++; if(t < 300) requestAnimationFrame(frame); else canvas.remove(); // Lasts longer
    }
    frame();
  }

  /* ---------- PDF download ---------- */
  downloadPdf.addEventListener('click', ()=>{
    try {
      // Make sure the jsPDF library is loaded
      if (typeof jsPDF === 'undefined') {
        alert("Error: PDF library not loaded. Please check your internet connection.");
        return;
      }
      const { jsPDF } = window.jspdf;
      
      const doc = new jsPDF({unit:'pt',format:'letter'});
      doc.setFontSize(14); doc.setFont("Times","Normal");
      // Split text to handle page breaks
      const lines = doc.splitTextToSize(CONFIG.letter, 520);
      doc.text(lines, 40, 60);
      doc.save("Happy_Birthday_Letter.pdf");
    } catch (e) {
      console.error("jsPDF failed:", e);
      alert("Error: Could not generate PDF. Please try again.");
    }
  });

  /* ---------- Mute toggle ---------- */
  muteBtn.addEventListener('click', ()=>{
    isMuted = !isMuted;
    if (masterGain) {
      masterGain.gain.value = isMuted ? 0 : 1;
    }
    muteBtn.textContent = isMuted ? "Unmute" : "Mute";
  });

  /* ---------- Play all songs sequentially ---------- */
  function playSong(index) {
    if (index >= audioEls.length) {
      onPlaylistComplete();
      return;
    }

    const audioEl = audioEls[index];
    let hasTriggeredNext = false;

    const onTimeUpdate = () => {
      if (hasTriggeredNext) return;
      if (audioEl.duration && (audioEl.duration - audioEl.currentTime) < CROSSFADE_TIME) {
        hasTriggeredNext = true;
        audioEl.removeEventListener('timeupdate', onTimeUpdate);
        playSong(index + 1); // start next
      }
    };

    audioEl.onended = () => {
      audioEl.removeEventListener('timeupdate', onTimeUpdate);
      if (!hasTriggeredNext) {
        playSong(index + 1);
      }
    };

    audioEl.addEventListener('timeupdate', onTimeUpdate);
    audioEl.currentTime = 0;
    audioEl.play().catch((e) => handleAudioError(e, index));
    crossfadeTo(index, 2.0);
  }

  /* ---------- After playlist completes ---------- */
  function onPlaylistComplete(){
    burstConfetti(); // Run new heart confetti
    finalOverlay.classList.add('show');
    finalOverlay.setAttribute('aria-hidden','false');
  }
  
  /* ---------- Final overlay close button ---------- */
  finalClose.addEventListener('click', ()=> {
    finalOverlay.classList.remove('show');
    finalOverlay.setAttribute('aria-hidden','true');
  });

  /* ---------- Orchestration / Start button ---------- */
  startBtn.addEventListener('click', async () => {
    initAudioContext();
    if (audioCtx && audioCtx.state === 'suspended') {
      try { await audioCtx.resume(); } catch(e){}
    }

    // Unlock playback permission
    for (let i = 0; i < audioEls.length; i++) {
      try { await audioEls[i].play(); audioEls[i].pause(); audioEls[i].currentTime = 0; }  
      catch(e){ handleAudioError(e, i); }
    }
    if (CONFIG.voiceNote) {
      try { await voiceEl.play(); voiceEl.pause(); voiceEl.currentTime = 0; }  
      catch(e){ handleAudioError(e, 'voice'); }
    }

    // show app & start visuals
    intro.style.opacity = 0;
    intro.setAttribute('aria-hidden', 'true');
    setTimeout(()=> {
      intro.style.display = 'none';
      app.classList.remove('hidden');
      app.setAttribute('aria-hidden', 'false');
    }, 600);

    // render first photo set & start cycles
    startFlipCardGallery(); // Start NEW gallery
    startFloatingParticles();

    // type letter while music plays
    typeWriter(CONFIG.letter, 28, ()=>{
      if (CONFIG.voiceNote) {
        voiceEl.play().catch((e) => handleAudioError(e, 'voice'));
      }
    });

    // finally start music chain
    playSong(0);
  });

}); // End DOMContentLoaded
